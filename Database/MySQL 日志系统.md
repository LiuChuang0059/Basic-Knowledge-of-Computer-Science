本文为 极客时间 丁奇老师 的《 MySQL 实战45讲》课程 学习笔记

----

## 1. 更新语句的执行流程

```sql

update T set c = c+ 1 where ID = 2 ;
```


执行流程，类似于上一篇笔记中介绍的查询流程

![](https://i.loli.net/2019/07/15/5d2c80370199a68830.png)


1. 连接数据库

2. 因为要更新数据表，所以和表相关的查询缓存都会失效， 更新命令就会清空所有的缓存结果

3. 分析器 通过 词法和语法的分析知道是一条更新语句

4. 优化器 确定使用 ID 的索引

5. 执行器开始执行 更新操作

6. 除了上述和查询流程相同的语句，  **更新还会涉及两个日志模块 ： redo log 和 binlog**



---

## 2. 日志模块 ： redo log

如果每次更新操作都要写进磁盘， 磁盘需要找到相应的记录，再进行更新，整个过程的 IO 成本，查找成本都是很高。

MySQL 为了提高更新的效率， 使用 Write-Ahead logging 技术： 先写入日志， 之后再写进磁盘


1. 存在记录需要更新的时候， InnoDB 引擎就会把记录写到 redo log里面，并更新内存

2. 在系统空闲的时候， InnoDB 引擎将操作记录更新到磁盘里面

3. 其中 redo log 的大小是固定的，写满了之后就不能再执行更新了， 需要把记录更新到磁盘里面，再擦除一些记录。

4. 存在 redo log ， InnoDB 保证数据库存在异常的时候， 之前的记录还保存， 存在 crash-safe 能力


**redo log 记录数据页 做了什么改动**


---

## 3. binlog --- 归档日志

redo blog 是 InnoDB 的日志， binlog 是 Sever 层的日志

> 存在两份日志的原因： MySQL 以前的引擎是 MyISAM 不存在 crash-safe 的能力。 InnoDB引擎是以插件形式引入到 MySQL， 使用另一套日志系统 来实现 crash- safe



* binlog 所有的引擎都可以使用， redo log 只有 InnoDB 可以使用

* redo log 记录的是物理日志 ： 记录某个数据页面修改了什么； binlog 逻辑日志， 记录 语句的原始逻辑

* redo 是固定大小，循环覆盖的， binlog 是可以追加写入，文件到一定的大小，会切换到下一个，覆盖之前的日志


**binlog 存在两种模式， statement 记录的是sql 语句； row 格式 记录更新前和更新后的 行的内容**

-----

## 4. 执行 UPDATE 的内部流程

```sql

update T set c = c+ 1 where ID = 2 ;
```


1. 执行期先找到 找到 ID =2 的行， 如果这一行所在的数据在内存之中，直接返回到执行器； 如果不在，需要先从磁盘读取到内存之中，再返回到执行器

2. 执行器获得数据之后， 更新数据的值，再调用引擎接口写入这行新的数据

3. 引擎将新的数据更新到内存之中， 更新的操作记录记录到 redo log， 此时 redo log 处于 prepare 状体啊

4. 执行器生成这个操作的 binlog ，把binlog 写入磁盘

5. 执行器调用引擎的 提交事务接口， 引擎把 redo log 改成 commit 状态

---

## 5. 两阶段 提交

redo log  的提交分为 prepare 和 commit 两部分


数据库误删 的数据恢复 ：

1. 找到一个全量备份， 从这个备份中恢复到临时库

2. 将备份的 binlog 一次提取出来， 重放到误删之前的



如果不是两阶段提交， ， 假如写完第一个日志之后 就发生了 crash



1. 先写 redo ，再写 bin ：

redo log 可以把数据恢复过来 ，恢复过来的数据和原库的相同；
但是由于 binlog 没有写入， binlog 没有相应的语句， 如果使用 binlog 恢复 临时库， 就会和原库的值不同

2. 先写 binlog ， 再写 redo log

binlog 写入之后 crash ，由于 redo log 没有写入 ，这个事务无效， 数据库值没有发生改变，但是 binlog 记录了 更新命令的日志， 使用 binlog 恢复就会多出来一个 没有执行的事务，与原库的值不相同。


**扩容的时候也需要恢复临时库**： 常见的做法是 全量备份加上应用 binlog 实现



**两阶段提交让两个状态 保持逻辑上的一致**


----


## 6. 参数设定

innodb_flush_log_at_trx_commit 参数设定为 1 ： redo log 直接持久化到 磁盘

sync_binlog 参数设定为1 ， 每次事务的 binlog。持久化到磁盘






























