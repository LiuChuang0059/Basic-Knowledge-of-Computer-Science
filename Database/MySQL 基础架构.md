本文为 极客时间 丁奇老师 的《 MySQL 实战45讲》课程 学习笔记

----

## 1. MySQL 基础架构


![](https://i.loli.net/2019/07/15/5d2c80370199a68830.png)

* MySQL 分为  Serve层 和 储存引擎层

1. Serve 层：

包括 MySQL 大多数核心功能，以及所有的内置函数


2. 储存引擎层：

负责数据的储存和提取， 默认储存引擎是 InnoDB

在 create table 的时候， 不指定引擎，就是 InnoDB

也可以在 create table 的时候 使用语句 engine = memory 来指定使用内存引擎创建表

---

## 2. 连接器

1. 首先，需要连接到数据库上， 使用连接器跟客户端建立连接，获取权限等。

```sql
mysql -h -P -u root -p

```

-h : 后面接 远端服务器 ip 地址

-P : 后面接 端口号


2. 连接完成之后，没有后续的命令， 连接就处于空闲状态， 默认超过 8 小时自动断开连接

```sql
mysql> show processlist;
+----+-----------------+-----------+------+---------+-------+------------------------+------------------+
| Id | User            | Host      | db   | Command | Time  | State                  | Info             |
+----+-----------------+-----------+------+---------+-------+------------------------+------------------+
|  4 | event_scheduler | localhost | NULL | Daemon  | 33233 | Waiting on empty queue | NULL             |
|  8 | root            | localhost | NULL | Query   |     0 | starting               | show processlist |
+----+-----------------+-----------+------+---------+-------+------------------------+------------------+
2 rows in set (0.00 sec)

```

3. 数据库连接分为 长连接和短连接

* 长连接 ： 客户端持续有请求， 一直使用同一个连接
* 短连接 ： 每次执行完几次查询就断开连接， 下次查询再建立一个

**建立连接过程复杂，但是一直使用长连接，占用内存会特别大，会被系统强行杀掉（OOM）， 导致 MySQL 异常重启**

solve：

* 定期断开长连接
* 执行 mysql_reset_connection 重新初始化连接资源（不需要重连和重新权限验证）

----

## 3. 查询缓存

建立连接之后， 执行语句

MySQL 接收到查询请求之后，会先到 查询缓存之中查找是否存在查询语句， 如果存在，，直接返回到客户端

查询缓存 保存之前执行过的语句 以 key-value 对的形式储存

**查询缓存往往弊大于利**

只要表存在一个更新，标上所有的查询缓存都会清空，所以如果数据库经常更新， 查询缓存的命中率会特别低
> 除非数据库表是一个 静态的表


**对于 MySQL 8.0 不存在 查询缓存的功能**

---


## 4. 分析器

MySQL 需要对 SQL语句进行解析

1. 先会做 “词法分析”

* 输入是多个字符串和空格组成，先要识别出其中的字符串分别是什么

* 识别关键字 select table id 等

* 验证 表名 和 字段名

2. 进行 “语法分析”

* 判断是否满足 SQL 语法


-----

## 5. 优化器

经过分析器之后，MySQL 知道需要做什么， 在执行之前，需要优化处理


表内存在多个索引的时候， 决定使用哪一个，或者存在多表关联，决定连接顺序

不同方案执行的效率不同，优化器就是进行方案选择


----

## 6. 执行器

开始执行语句

1. 首先会判断对 要执行的表是否有查询权限

没有权限会报错

```sql
mysql> select * from T where ID=10;

ERROR 1142 (42000): SELECT command denied to user 'b'@'localhost' for table 'T'

```

2. 如果有权限，就会打开表，执行流程

2-1 如果没有索引

* 调用 InnoDB 引擎接口调取表的第一行，判断 ID 是不是 10 ， 不是就跳过，是就储存在 结果集之中

* 调用 InnoDB 引擎接口调取表的 下一行，重复操作，直到最后一行

* 结果返回到客户端


2-2 如果存在索引的表

* 调用 满足条件的第一行 接口

* 之后循环 满足条件的下一行 接口，（这些接口在引擎中已经定义好）


---

## 7. 思考题

如果执行语句
```sql
select * from T where k = 1;
```
数据库表中没有 k 这个字段，执行会报错

这个报错会出现在 分析器阶段， 分析器会验证表名和字段名
































