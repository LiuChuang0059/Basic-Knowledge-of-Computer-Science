
* 本文主要内容为**刘超**老师在极客时间上的《趣谈网络协议》课程学习笔记

----

> 除了 在宿舍和办公室的局域网， 还有外网

### 宿舍上网

> 宿舍给每个网口分配一个 IP地址，校园网的 IP；10.10.x.x 宿舍网 有个 IP地址 ： 192.168.1.x

* 路由器的外网网口插到校园网网口上， 外网网口配置成和网管部门一样； 内网网口连接宿舍的所有电脑

* 接下来需要网卡配置 ： IP地址由 DHCP 默认配置； 还需要 **Gateway** 配置


-----

### 跨网关访问 的 MAC 头 和 IP 头


![](https://github.com/LiuChuang0059/large_file/blob/master/pic/bupdl.jpg)

* MAC 头中的协议类型，用来说明里面是 IP协议

* IP 头 里面的版本 是 IPV4 或者 IPV6

* 服务类型 Type of Sevice : TOS 代表了当前包的优先级；

* TTL

* 8 位协议 ： 是 TCP or UDP

-----

### 判断是否是同一个网段

> 需要 CIDR 和子网掩码

* 如果是同一个网段
> 将源地址和目标地址放入IP头中， 然后通过 ARP 获得 MAC ，将源MAC 和目的 MAC 放入 MAC 头中； 发出。

* 如果不是同一网段

1. 需要发往默认网关 Gateway 。 Gateway 的地址一定是和 源 IP 是一个网段的。
> 例如 192.168.1.0/24 这个网段，Gateway 往往会是 192.168.1.1/24 或者 192.168.1.2/24。

2. 由于网关和源 IP 地址是同一个网段的，过程类似于发往同一个网段 -- 通过 ARP 获得网关的MAC 地址，将源MAC 和网关 的MAC 放入 MAC 头

3. 网关所在的端口将网络包收入， 拿下MAC头和IP头，选择另一个网关，加上 IP头和MAC头 发送

----

### 静态路由

> 在 路由器上配置一条条的规则； 例如想访问 BBS 站，从2号口出去，下一跳 是 IP2

----

### IP 地址不变
![](https://github.com/LiuChuang0059/large_file/blob/master/pic/ojfd1.jpg)

> 服务器A 访问 服务器 B； 不在同一个网段

1. A 将包发送到网关 ； 包中有：
	* 	源 MAC ： 服务器A 的 MAC
	*  目标 MAC ： 网关的 MAC
	* 源 IP ： 服务器 A 的IP地址、
	* 目标 IP ： 服务器B 的地址


2. 路由器 A 中配置了静态路由， 知道从 92.168.56.1 这个口出去，下一跳为 192.168.56.2
> 下一跳 ： 某个 IP 要将这个 IP 地址转换为 MAC 放入 MAC头



3. 获取 192.168.56.2 的 MAC 地址，打包发送，IP 不变

4. 路由器B中配置了静态路由， 从 192.168.4.1 这个口出去，没有下一跳，获取 服务器B的 MAC地址 发送包

-----

### IP 地址改变

![](https://github.com/LiuChuang0059/large_file/blob/master/pic/5vki4.jpg)

> 局域网的 IP 段冲突了

1. 目标服务器的 IP 转换，  192.168.1.101 对应 192.168.56.2

2. 服务器 A 访问 目标服务器 B 指定的目标地址 192.168.56.2

3. 其他的 程序类似于上一个，直到 包到达 路由器B

4. 路由器 B 是一个 NAT 网关，它上面配置了，192.168.1.101 对应 192.168.56.2，改为访问 192.168.1.101
> NAT :Network Address Translation，简称NAT

5. 从路由器 B 的192.168.1.1 这个口发出 发给192.168.1.101 ； 源 IP ： 192.168.56.1



















