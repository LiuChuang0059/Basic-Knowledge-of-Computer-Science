
* 本文主要内容为**刘超**老师在极客时间上的《趣谈网络协议》课程学习笔记

----

> 只介绍视频传输，没有音频 ！！！

---


### 1. 视频大小

1. 每一张图片称为一 帧

2. 每一张图片都是由像素组成的，假设1024* 768，

3. 每个像素由 RGB组成， 每个 8位，共24位

4. 一秒钟 ： 30 帧 * 1024* 768 * 24 = 7077888Bytes

5. 一分钟 ： 约 4 个 G

----

### 2. 编码-- 压缩视频

#### 1. 能够编码的原因

1. 空间冗余 ： 图像的相邻像素之间存在较强的相关性，可以隔几个保存一个，中间的使用算法及孙啊出来

2. 时间冗余： 视频序列的相邻图像之间内容相似，可以预测和推断

3. 视觉冗余： 人眼对某些细节并不敏感，可以丢失一些细节

4. 编码冗余 ：不同像素值出现的概率不同， 概率高的字节少，概率低的字节多


#### 2. 编码过程


![](https://github.com/LiuChuang0059/large_file/blob/master/pic/oar7v.jpg)


#### 3. 视频编码的主要流派

* 一：  国际电联的 VCEG --- 侧重传输
> H.261, H.264 等等就是这个组织制定的标准

*  二： ISO 的 MPEG --- 侧重于 视频储存
> MPEG-1 , M PEG-2 等 就是这个组织制定的标准


**ITU 和 MPEG 联合制定了H.264/MPEG-4 AVC**

> 编码之后， 图像转换为二进制，以一定的格式保存，例如：AVI ， MPEG  RMVB MP4.。。。。



----


### 3. 网络传输 --- 直播


#### 1. 过程

![](https://github.com/LiuChuang0059/large_file/blob/master/pic/k57rd.jpg)

##### 1. 接流

* 网络协议将编码好的 视频流，从主播端推送到服务器，在服务器上面有运行着同样协议的服务端接受网络包， 从而得到里面的视频流

##### 2. 流处理

* 服务端收到视频流之后， 视频进行转码，从一个编码格式转换为另一种编码格式， 对应不同的客户端

##### 3. 拉流

* 观众的客户端请求过程称为 拉流

##### 4. 分发

* 观众多，都从一个服务器上拉流对服务器压力太大， 需要视频分发网络，视频预先加载到边缘节点， 从边缘节点拉取

##### 5. 解码

* 拉取到视频流之后，将二进制转换成图片播放

------

#### 2. 编码

将视频序列分为三种帧

* I 帧 ： 关键帧， 包含完整的图片

* P 帧： 前向预测编码帧。包含的是这一帧和之前一个关键帧（或者P 帧）的差别，解码需要之前的画面

* B 帧 ： 双向预测内插编码帧。 包含本帧和前后帧之间的差别。 解码需要之前缓存的画面还需要之后的画面

##### 1. 通过时序进行编码

* IBBP 序列

##### 2. 空间上 编码
* 帧 --> 片 --- > 宏块 --> 子块

![](https://github.com/LiuChuang0059/large_file/blob/master/pic/a4xtw.jpg)


##### 3. 压缩成 二进制流

* 流是一个个网络提取单元 NALU (Network ABstraction Layer Unit), 为了便于包的传输，分成一个个单元

![](https://github.com/LiuChuang0059/large_file/blob/master/pic/65lcj.jpg)

1. NALU 前部一个 起始标识符-- 标识 NALU 之间的间隔

2. NALU 头： 包含 不同的类型

* SPS ： 序列参数集 包含一个图像序列所有信息，图像的大小，视频的格式

* PPS ： 图像参数集 包含图像 的所有分片的所有相关信息，图像的类型，序列号

**为了保证容错性，每个I帧前面都传一遍 SPS和PPS**


3. NALU playeload ： 帧、承载的数据
> 如果 类型是 SPS或者 PPS， playload 是参数集
> 如果类型是 帧； palylaod 是真正的 视频数据， 每个 NALU 存放一片


**一个视频，拆分成一系列的额帧，每一帧拆分成一系列的片，每一片放在 NALU里面，NALU 之间通过标识符分割， I帧前面插入 SPS和PPS 、，最终形成 NALU 序列**


------

#### 2. 推流

> 二进制流需要打包成网络包才能发送 --- RTMP 协议


* RTMP 基于 TCP ，双方建立一个TCP连接，之后再建立一个 RTMP 连接
> RTMP 建立连接之后 确定 **版本号**和 **时间戳**

* 客户端发送 C0 ，C1，C2； 服务器发送 S0， S1， S2

![](https://github.com/LiuChuang0059/large_file/blob/master/pic/szq7h.jpg)

1. 客户端 C0 表示自己的版本号，了 不等回复直接发送 C1 表示自己的时间戳

2. 服务器收到 C0 后回复 S0 表明自己版本号，接着发送 S1 表明时间戳

3. C2 是客户端对服务器 发送时间戳的一个回复 ACK ，同理 S2

----

* 传输数据的时候： 创建一个流 Stream，通过他进行 推流
>  将 NALU 放入 Message 里面发送 --- **RTMP Packet包**

![](https://github.com/LiuChuang0059/large_file/blob/master/pic/5fsct.jpg)


* RTMP 收发数据不是以 Message 拆分成 Chunk 发送； 在一个 CHunk发送完 才能发送下一个，
> Chunk 里面有 Message ID，表示属于哪个 Message 便于组装
> 这样将大的消息变为小的，在低带宽的情况下，减少网络拥塞


**整个过程**

![](https://github.com/LiuChuang0059/large_file/blob/master/pic/ycs6j.jpg)

---


#### 3.  分发网络

>  观众可以通过 RTMP 协议从流媒体服务器上拉去视频，但是，都去同一个地方拉去，服务器压力大，时延长，需要分发网络

![](https://github.com/LiuChuang0059/large_file/blob/master/pic/09eyi.jpg)

* 分为 中心和边缘两层
> 边缘层服务器部署在全国各地，横跨各大运营商。中心层是流媒体服务集群，负责内容的转发

* 根据用户的地理位置信息，就近选择边缘服务器

* 中心服务器可以进行转码的工作

----

#### 4. 拉流  --- 观众通过客户端观看

![](https://github.com/LiuChuang0059/large_file/blob/master/pic/lynmr.jpg)

* 客户端 将收到的 NALU 组成一个个帧，进行解码，播放器播放







































