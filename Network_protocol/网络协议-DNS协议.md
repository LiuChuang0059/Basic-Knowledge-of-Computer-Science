
* 本文主要内容为**刘超**老师在极客时间上的《趣谈网络协议》课程学习笔记

----

> IP 地址难以记住，网站的名称容易记， 需要一个地址簿。根据名称，查看具体的地址。

---


### 1. DNS 服务器

> 几乎每个人上网都需要访问 DNS，  如果只有一个服务器，所有人都去访问， 时延回非常大。

**DNS 服务器，设置成高可用，高并发和分布式**


![](https://github.com/LiuChuang0059/large_file/blob/master/pic/zm89z.jpg)


* 根 DNS 服务器 ： 返回顶级域 DNS 服务器的 IP 地址

* 顶级域 DNS 服务器 ： 返回权威 DNS服务器的 IP 地址

* 权威 DNS 服务器 ： 返回相应主机的 IP 地址

---

### 2.  DNS 解析流程

![](https://github.com/LiuChuang0059/large_file/blob/master/pic/4hwlb.jpg)


1. 客户端发送一个 DNS 请求，询问 163 的 ip 地址， 发给本地域名服务器（本地 DNS）
> 本地 DNS ： 由网络服务商 自动分配，通常在网络服务商的某个机房。

2. 本地的 DNS 收到客户端的请求。 服务器上面缓存了一张域名和IP对应的表。

* 如果能够找到，直接返回 IP 地址。

* 如果找不到， DNS 去询问**根域名服务器**， 根域名服务器 不直接解析域名，但是可以指示方向

3. **根 DNS** 收到 本地 DNS 的请求，发现后缀是 .com ，就会给出他的顶级域名服务器地址（比如： .com , .net .org）

4. 本地 DNS 转向询问**顶级域名服务器**， 询问 IP 地址， 顶级域名服务器告诉 IP的 权威 DNS 服务器地址。

5. 本地 DNS 转向询问**权威 DNS 服务器**， 询问 IP 地址，权威 DNS 服务器 查询到之后，将相应的 IP 地址，告知本地 DNS

6. 本地 DNS 将 IP 地址返回客户端，客户端和目标建立连接。

------

### 3. DNS 处理负载平衡
> 就近分配地址--- 负载平衡

#### 1. 内部负载平衡

* 应用访问数据库， 应用里面应该配置数据的 IP 地址海 his数据哭的域名？
> 配置域名较好，因为数据哭因为某种原因，换到了另外的机器，IP地址改变， 应用全部修改一遍。
> 配置了域名，只要在 DNS 服务器里面 ，将域名映射到 新的 IP地址。


* 应用访问 另外一个应用，配置域名，就可以负载均衡。 在域名解析的时候，配置策略： 这次返回第一个 IP，第二次返回第二个 IP。


#### 2. 全局 负载平衡

*  为了保证应用高可用，往往会部署在多个机房，每个地方都有自己的 IP 地址。用户访问某个域名的时候， IP地址轮番访问多个数据中心，一个挂掉了， 在DNS 服务器里面，将对应的IP删除就可以

* 实现 北京的用户访问北京的数据中心，上海的用户访问上海的数据中心。
----


### 4. 实例 ： DNS 访问数据中心中**对象储存**上的静态资源。

#### 1. 构成

*  全国有多个数据中心，托管在多个运营商； 每个数据中心有 三个 可用区（Avaliable Zone）

*  对象储存通过跨可用区部署，高可用性

* 每个数据中心中，都部署两个**内部负载均衡器**

* 负载均衡器后面对接多个 对象储存的 前置服务器（Proxy-server）

#### 2.  过程

![](https://github.com/LiuChuang0059/large_file/blob/master/pic/eooas.jpg)

---

1. 客户端 访问网页时候，需要将域名转换为 IP地址进行访问， 请求**本地DNS解析器**

2. **本地DNS 解析器** 先查看本地的缓存是否有这个记录，如果有直接使用；如果本地没有缓存，请求**本地 DNS 服务器**

3. 本地的DNS服务器查看本地是否有缓存，有则返回

4. 如果没有，递归查询，返回IP 地址。
> 对于不需要全局负载均衡的简单应用，权威 DNS 服务器可以直接将 域名解析为一个或者多个 IP 地址，然后客户端通过多个 IP 地址，进行简单的轮询，实现简单的负载均衡

----

#### 3. 全局负载均衡器 GSLB，Global Sever Load Balance
> 对于复杂的应用，需要更加复杂的全局负载均衡机制

* 例如，在 liuc.com 的 DNS服务器， 一般是通过配置 CNAME的方式， 给 www.liu.com 起一个别名，例如 www.dd.liuc.com ,告知 本地 DNS 服务器，让本地 DNS服务器请求 GLSB 解析这个域名； GLSB 在解析域名的时候，实现负载平衡。


------


1.  第一层 GLSB， 通过查看请求他的本地 DNS 服务器所在的运营商，知道用户所在的**运营商**。

2. 之后，通过 CHAME 的方式，通过另一个 别名 www.yd.liuc.com 告知本地DNS服务器 请求第二层 GLSB；

3. 第二层的 GLSB 通过查看 本地 DNS 服务器所在的地址，知道用户的**地理位置**

4. GSLB 将距离用户比较近的 Region 里面，6 个 SLB 的地址返回给**本地 DNS服务器**

5. **本地 DNS服务器** 将结果返回给 **本地 DNS 解析器**

6. **本地 DNS 解析器** 将结果缓存后，返回给客户端

7. 客户端访问属于相同**运营商**的 而且**距离较近的** Region1 中的 对象储存。得到 6个 IP地址，通过负载平衡的方式，选择一个可用区进行访问。


> 两层 是因为，分运营商和地域。希望不同的运营商客户，可以访问对应的运营商机房中的资源，不跨运营商访问，提高吞吐量，减少时延
> 对象储存 一般会有3 个备份，实现对储存读写的负载均衡 ---- Storage集群


-----

### 5.  DNS 存在的问题


#### 1. 域名缓存问题

##### 1. 本地缓存

* 可以直接返回本地缓存的数据；

* 但是，有可能网络页面发生了变化，但是**缓存没有刷新**

##### 2. 运营商服务器缓存
* 运营商吧一些静态页面，缓存到本运营商的服务器内；用户请求的时候，不需要跨运营商进行访问。 在域名解析的时候，不会将用户导向真正的网站，而是指向缓存的服务器
> 但是当页面更新，用户会访问到老的页面。如果页面有更新，看不到更新

##### 3. 本地缓存

* 本地缓存导致 全局负载均衡失败
> 因为上次进行缓存的时候，缓存中的地址不一定是这次访问里客户最近的地方， 地址返回给客户，可能会绕远

----

#### 2. 域名转发问题

* 运营商 A 的客户访问自己运营商的 DNS 服务器，如果 A 运营商去权威 DNS 服务器查询，权威 DNS 服务器会返回一个部署在 运营商 A 的 网站地址，相同运营商的访问，速度会快很多

* **但是**， 运营商 A 偷懒，将解析的请求转发给 运营商 B， 运营商 B 去权威 DNS 服务器查询的话，权威服务器误认为是 运营商 B， 返回一个在运营商 B 的网站地址，可贺访问需要跨运营商，速度缓慢。

![](https://github.com/LiuChuang0059/large_file/blob/master/pic/wszh7.jpg)

----

#### 3. 出口 NAT 问题

* 出口的时候，机房配置 NAT --- 网络地址转换， 使得从网关传出去的包换成新的 IP 地址； 请求返回的时候，在这个网关将 IP 地址转换回去

* **网络地址转换之后**， 权威的 DNS 服务器，没办法通过这个地址判断来自哪个运营商；很可能导致误判

-----

#### 4. 域名更新问题


* 本地 DNS 服务器是由不同地区，不同运营商独立部署的。对域名解析缓存的处理上，实现的策略也不尽相同
>  有的在权威 DNS 服务器解析变更的时候，解析结果在拳王生效的周期漫长

* 例如：双机房部署的时候， 当一个机房出现问题之后，需要修改权威 DNS， 将域名指向新的 IP 地址，但是如果更新的太慢，用户会出现访问异常。


----

#### 5. 解析延迟问题

* DNS 查询的过程需要递归遍历多个 DNS 服务器，才能得到最终的结果，会带来一定的时延，甚至解析超时

----
----

### 6.  HTTPDNS 工作模式

#### 1. HTTPDNS 简述

> 不走传统的 DNS 解析，而是自己搭建基于 HTTP协议的 DNS 服务器集群，分布在多个地点和多个运营商。 当客户端需要 DNS 解析的时候，直接通过 HTTP协议进行请求这个服务器集群，得到就近的地址。


* 每家基于 HTTP 协议，自己实现自己的域名解析，自己做一个自己的地址簿。

* 但是默认的域名解析都是走 DNS ，使用 HTTPDNS 需要绕过默认的 DNS路径，不能使用默认的客户端
> 使用 HTTPDNS的，多半是手机应用，需要手机端嵌入支持 HTTPDNS的客户端 SDK。


---

#### 2. HTTPDNS 工作模式

![](https://github.com/LiuChuang0059/large_file/blob/master/pic/76ap2.jpg)

1. 在客户端 SDK 里面动态请求服务端， 获取 HTTTPDNS 服务器的 IP 地址，缓存到本地，随着不断解析域名， SDK 也不断在本地缓存 DNS 域名解析的结果

2. 手机应用访问一个地址的时候，查看本机是否有缓存，如果有就直接返回
> 不同于 本地 DNS 的缓存，不是整个运营商统一做的；如何更新，何时更新，手机应用的客户端可以和服务器协调

3. 如果本地没有，需要请求 HTTPDNS 的服务器， 在本地 HTTPDNS服务器 的 IP 列表中，选择一个发出 HTTP 的请求，返回一个要访问的网站的 IP列表
> 手机客户端知道手机的 运营商和地址。直接的 HTTP 通信，HTTPDNS 服务器可以准确知道这些信息。

4. 如果这些都不工作，切换到传统的 LocalDNS 解析

----

#### 3， HTTPDNS 的缓存设计

* HTTPDNS 将解析速冻和缓存的更新速度自己转空

> 解析的过程不需要 DNS服务递归调用，只需要一个 HTTP 请求
> 缓存是在客户端 SDK 维护的， 更新时间自己掌控

* 缓存设计模式
![](https://github.com/LiuChuang0059/large_file/blob/master/pic/v1d7g.jpg)

1. DNS 缓存在内存中，但是也可以持久化到储存上面。
> APP重启之后，尽快从储存中加载上次累积的经常访问的网站的解析结果。

2. SDK 中的缓存会严格按照缓存过期时间。缓存过期，客户端发起一次解析

##### 1. 解析可以同步进行，
* 直接调用 HTTPDNS的借口，返回最新的记录，更新缓存

![](https://github.com/LiuChuang0059/large_file/blob/master/pic/zu93c.jpg)

1. 先读取缓存，

2. 没有的话 读取数据库

3. 将结果写入缓存

* 优点是实时性好

* 缺点是：多个请求都发现过期，会同时请求



##### 2. 解析可以异步进行，
* 添加一个解析任务到后台，后台任务调用 HTTPDNS


![](https://github.com/LiuChuang0059/large_file/blob/master/pic/mf9xu.jpg)

1. 业务仅仅访问缓存，

2. 缓存过期的时候定期刷新

------


#### 4.  HTTPDNS 的调度设计

##### 1. 客户端

* 可以知道用户的具体位置，运营商， 服务端可以根据这些信息，选择最佳额度服务节点返回。

* 如果有多个节点，还会考虑错误率，请求时间，服务器压力，网络状况等进行综合选择；当有一个节点性能下降，可以快速切换

##### 2. 服务端

* 应用可以通过调用不同的 HTTPDNS管理接口，配置不同服务质量的优先级，权重

* HTTPDNS 通过智能调度之后返回的结果也会缓存在客户端。

![](https://github.com/LiuChuang0059/large_file/blob/master/pic/uvn2o.jpg)






































* 优点是，多个请求都过期，合并为一个。 同时，在即将过期的时候创建一个任务进行预加载，防止过期之后在刷新

































































































